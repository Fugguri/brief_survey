# üá∫üá∏ English

## BriefSurvey
Universal Dynamic Survey for Telegram Bots with `aiogram` version 3 `aiogram_dialog` and Pydantic
### Description
BriefSurvey is a module for quick and flexible creation of dialog-based surveys in Telegram using aiogram v3 and aiogram_dialog.

- Questions are defined using Pydantic models to enforce strong typing and validation.
- Final answers are automatically serialized back into a Pydantic result model.
- Easy to extend and customize.
- Supports different question types: text, number, single-choice, multiple-choice.
- Simple integration and handler registration.

---
## Installation
### From GitHub Repository

```bash
pip install git+https://github.com/Fugguri/brief_survey.git 
```
### Download Locally and Install

```bash
git clone https://github.com/Fugguri/brief_survey.git
pip install -e brief_survey 
```


## Quick Start
### (case 1) Dynamic crate a brief 
```python
from brief_survey import BriefSurvey
from brief_survey.validators.person import age
async def save_handler(user_id: int, result: any):
    # dynamic access to survey result fields by question name.
    name = result.name
    age = result.age
    gender = result.gender

    return

survey = BriefSurvey(
    save_handler=save_handler,
    start_command='start_brief'  # customizable start command for the survey
)

# Customizable error messages
survey.info_messages.invalid_input = "Invalid data received, please try again."
# Customizable button text at the end of the survey
survey.buttons.finish_text = "Finish survey"

survey.add_question(
    text="What is your name?",
    question_type="text",
    name="name",
    media_path='storage/media/img.png'  # you can send media with text for any question (optional)
)

survey.add_question(
    text="Your age?",
    question_type="number",
    name="age",
    validator=age # You can use validators from validators path of this lib.
)


survey.add_question(
    text="Select your gender",
    question_type="choice",
    name="gender",
    choices=["Male", "Female"],
    next_questions={
        'Male': "favorite_car",
        'Female': "favorite_color",
    }
)

survey.add_question(
    text="Favorite car brand?",
    question_type="choice",
    name="favorite_car",
    choices=["MBW", "Mercedes"],
    next_question='photo'  # mandatory parameter for queries depending on choice. If not set, proceeds to next survey question
)

survey.add_question(
    text="Favorite color?",
    question_type="choice",
    name="favorite_color",
    choices=["White", "Pink", "Black"],
    next_question='photo'  # mandatory parameter for queries depending on choice. If not set, proceeds to next survey question
)

survey.add_question(
    text="Upload your photo",
    question_type="photo",
    name="photo"
)

```
### (case 2) 1. Define your questions using Pydantic models:

```python
from brief_survey import QuestionBase, ChoiceQuestion, MultiChoiceQuestion

questions = [
    QuestionBase(
        name="name",
        text="What is your name?",
        type="text",
        validator=lambda x: bool(x.strip()),
    ),
    ChoiceQuestion(
        name="gender",
        text="Select your gender",
        type="choice",
        choices=[("1", "Male"), ("2", "Female")],
    ),
    MultiChoiceQuestion(
        name="profession",
        text="Select your profession",
        type="multi_choice",
        choices=[
            ("1", "Athlete"),
            ("2", "Entrepreneur"),
            ("3", "Worker"),
        ],
    ),
]

```
### 2. Define a result model:
``` python
from pydantic import BaseModel
from typing import Optional

class SurveyResult(BaseModel):
    name: Optional[str]
    gender: Optional[str]
    profession: Optional[list[str]]
```
### 3. Create a function to save results:
``` python
async def save_handler(user_id: int, result: SurveyResult):
    # Save logic, e.g., store in database
    print(f"User {user_id} survey result: {result}")

```
### 4. Initialize and register the survey:
``` python
from brief_survey import BriefSurvey

survey = BriefSurvey(
    questions=questions,
    save_handler=save_handler,
    result_model=SurveyResult,
)

# In your main bot file with Dispatcher dp
survey.register_handlers(
    dp=dp,
    command_start='start_survey',     # optional
    text='Start survey',               # optional
    callback_data="start_survey"       # optional
)
```
### 5. Launch the survey in Telegram with the command:
 /start_survey



## Important
If you have global handlers in your bot, filter states explicitly using StateFilter to avoid conflicts that can break the survey after the first message:
``` python
from aiogram.filters import StateFilter

dp.message.register(handle, StateFilter(None))          # Only outside states
dp.callback_query.register(handle_callback, StateFilter(None))
```

# üá∑üá∫ –†—É—Å—Å–∫–∏–π

## BriefSurvey

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å–Ω–∏–∫ –¥–ª—è Telegram-–±–æ—Ç–æ–≤ –Ω–∞ –±–∞–∑–µ `aiogram_dialog` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Pydantic-–º–æ–¥–µ–ª–µ–π –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---

## –û–ø–∏—Å–∞–Ω–∏–µ

BriefSurvey ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏ –≥–∏–±–∫–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–ø—Ä–æ—Å–Ω–∏–∫–æ–≤ –≤ Telegram —Å –ø–æ–º–æ—â—å—é `aiogram` 3-–π –≤–µ—Ä—Å–∏–∏ –∏ `aiogram_dialog`.

- –í–æ–ø—Ä–æ—Å—ã –æ–ø–∏—Å—ã–≤–∞—é—Ç—Å—è Pydantic-–º–æ–¥–µ–ª—è–º–∏ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
- –ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ Pydantic-–º–æ–¥–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ä–æ—Å–Ω–∏–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –≤–æ–ø—Ä–æ—Å–æ–≤: —Ç–µ–∫—Å—Ç, —á–∏—Å–ª–æ, –≤—ã–±–æ—Ä –æ–¥–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
- –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞
### Github Repo
```bash
pip install git+https://github.com/Fugguri/brief_survey.git 
```
### –°–∫–∞—á–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
```bash
git clone https://github.com/Fugguri/brief_survey.git
pip install -e brief_survey 
```


## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
### (1 –≤–∞—Ä–∏–∞–Ω—Ç) –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
```python

from brief_survey import BriefSurvey
async def save_handler(user_id: int, result: any):
    #–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—è–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø—Ä–æ—Å–∞ –ø–æ –∏–º–µ–Ω–∏ –≤–æ–ø—Ä–æ—Å–∞. 
    name = result.mame
    age = result.age
    gender = result.gender 
    return 
survey = BriefSurvey(
    save_handler=save_handler,
    start_command='start_brief' # –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–æ—Å–∞
)

#–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
survey.info_messages.invalid_input = "–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑"

#–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏ –∏ –∫–Ω–æ–ø–∫—É –≤ –∫–æ–Ω—Ü–µ –æ–ø—Ä–æ—Å–∞
survey.info_messages.invalid_input = "–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑"
survey.buttons.finish_text = "–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–ø—Ä–æ—Å" 
from brief_survey.validators.person import age  
survey.add_question(
    text="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
    question_type="text",
    name="name",
    media_path='storage/media/img.png'# –ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤–º–µ—Å—Ç–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º
)
survey.add_question(
    text="–í–∞—à –≤–æ–∑—Ä–∞—Å—Ç?",
    question_type="number",
    name="age",
    validator=age # –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ validators
)
survey.add_question(
    text="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª",
    question_type="choice",
    name="gender",
    choices=["–ú—É–∂—Å–∫–æ–π", "–ñ–µ–Ω—Å–∫–∏–π"],
    
    next_questions={
    '–ú—É–∂—Å–∫–æ–π': "favorite_car",
    '–ñ–µ–Ω—Å–∫–∏–π': "favorite_color",
    }
    
)
survey.add_question(
    text="–õ—é–±–∏–º–∞—è –º–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è?",
    question_type="choice",
    name="favorite_car",
    choices=["MBW", "Mercedes"],
    next_question='photo' # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç –≤—ã–±–æ—Ä–∞. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ –ø–æ –æ–ø—Ä–æ—Å—É

)
survey.add_question(
    text="–õ—é–±–∏–º—ã–π —Ü–≤–µ—Ç?",
    question_type="choice",
    name="favorite_car",
    choices=["–ë–µ–ª—ã–π", "–†–æ–∑–æ–≤—ã–π", "–ß–µ—Ä–Ω—ã–π"],
    next_question='photo' # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∑–∞–≤–∏—Å—è—â–∏—Ö –æ—Ç –≤—ã–±–æ—Ä–∞. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å, –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ –ø–æ –æ–ø—Ä–æ—Å—É
)

survey.add_question(
    text="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ",
    question_type="photo",
    name="photo"
)

````

### (2 –≤–∞—Ä–∏–∞–Ω—Ç) 
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–æ–ø—Ä–æ—Å—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–¥–µ–ª–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è):

```python
from brief_survey import QuestionBase, ChoiceQuestion, MultiChoiceQuestion

questions = [
    QuestionBase(
        name="name",
        text="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
        type="text",
        validator=lambda x: bool(x.strip()),
    ),
    ChoiceQuestion(
        name="gender",
        text="–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª",
        type="choice",
        choices=[("1", "–ú—É–∂—Å–∫–æ–π"), ("2", "–ñ–µ–Ω—Å–∫–∏–π")],
    ),
    MultiChoiceQuestion(
        name="gender",
        text="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
        type="multi_choice",
        choices=[("1", "–°–ø–æ—Ä—Ç—Å–º–µ–Ω"), 
                 ("2", "–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å"),
                 ("3", "–ü—Ä–æ—Å—Ç–æ–π —Ä–∞–±–æ—Ç–Ω–∏–∫")
                 ],
    )
]



```
### 2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–æ–¥–µ–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
``` python
from pydantic import BaseModel
from typing import Optional


class SurveyResult(BaseModel):
    name: Optional[str]
    gender: Optional[str]
```
### 3. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
```python

async def save_handler(user_id: int, result: SurveyResult):
    # –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–∞–∑—É
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {result}")
```
### 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –æ–ø—Ä–æ—Å–Ω–∏–∫:
``` python
from brief_survey import BriefSurvey

survey = BriefSurvey(
    questions=questions,
    save_handler=save_handler,
    result_model=SurveyResult,
)

# –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ñ–∞–π–ª–µ —Å –±–æ—Ç–æ–º (Dispatcher dp) —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Dispatcher
survey.register_handlers(dp=dp,
                         command_start='start_survey', #–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                         text='–ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å', #–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                         callback_data="start_survey" #–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                         )
```
### 5.–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ Telegram:
/start_survey

## –í–∞–∂–Ω–æ.
–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π handler, —Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ state –≤—Ä—É—á–Ω—É—é, –ø—Ä–∏ –ø–æ–º–æ—â–∏ StateFilter.
–ù–µ—è—Å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø—Ä–æ—Å–Ω–∏–∫ –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

``` python
from aiogram.filters import StateFilter
dp.message.register(handle,StateFilter(None))  # —Ç–æ–ª—å–∫–æ –≤–Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π!
dp.callback_query.register(handle_callback,StateFilter(None))
```


# ToDo
- add media list handler 
- add forced_exit to terminate survey
- optional message when survey starts *
- keyboards when the survey ended
- add button to final message "repeat" or  "start again" *
- fix result model validator
# for any errors send me a telegram message to @fugguri.
# ‚òïÔ∏èbye me a coffe appreciated 